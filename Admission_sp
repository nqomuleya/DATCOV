GO
exec staging.[dbo].[sp_admissions_import_nicd]
CREATE PROCEDURE [dbo].[sp_admissions_import_nicd]
AS
BEGIN
	drop table if exists [Sandbox].[Covid_admission]
	CREATE TABLE [Covid_admission]
	( PatientId	Varchar(100),
	NICD_Case_ID	Varchar(100),
	[Name]	Varchar(100),
	Surname	Varchar(100),
	ID_Number	Varchar(100),
	Age	Varchar(100),
	Age_group	Varchar(100),
	Sex	Varchar(100),
	Birth_Date	Varchar(100),
	Ethnic_Group	Varchar(100),
	Diagnosis_Date	Varchar(100),
	Admission_Date	Varchar(100),
	LOS	Varchar(100),
	Facility	Varchar(100),
	Sector	Varchar(100),
	Province	Varchar(100),
	District	Varchar(100),
	Sub_District	Varchar(100),
	Discharge_Status	Varchar(100),
	OutcomeDate	Varchar(100),
	Healthcare_Worker	Varchar(100),
	Healthcare_type	Varchar(100),
	Ward_upon_admission	Varchar(100),
	Intensive_Care_Unit	Varchar(100),
	High_Care	Varchar(100),
	General_Ward	Varchar(100),
	--Isolation_Ward	Varchar(100),
	Currently_Oxygenated	Varchar(100),
	Currently_Ventilated	Varchar(100),
	Comorbidity	Varchar(100),
	Hypertension	Varchar(100),
	Diabetes	Varchar(100),
	Admission_Cardiac	Varchar(100),
	COPD	Varchar(100),
	Asthma	Varchar(100),
	Chronic_Renal	Varchar(100),
	Malignancy	Varchar(100),
	Current_Tuberculosis	Varchar(100),
	Past_Tuberculosis	Varchar(100),
	HIV Varchar(100),
	Export_Date	Varchar(100)
	)
------- Add data to archive
	insert into [Sandbox].[dbo].[Covid_admission]
		( [PatientId],
		[NICD_Case_ID],
		[Name],
		[Surname],
		[ID_Number],
		[Age],
		[Age_group],
		[Sex],
		[Birth_Date],
		[Ethnic_Group]
		, [Diagnosis_Date],
		[Admission_Date],
		[LOS],
		[Facility],
		[Sector],
		[Province],
		[District],
		[Sub_District],
		[Healthcare_Worker]
		, [Ward_upon_admission],
		[Intensive_Care_Unit],
		[High_Care],
		[General_Ward] /*, [Isolation_Ward]*/
		, [Currently_Oxygenated],
		[Currently_Ventilated],
		--Comorbidity ,
		Hypertension	,
		Diabetes	,
		Admission_Cardiac	,
		--COPD	,
		Asthma	
		, Chronic_Renal	,
		Malignancy	,
		Current_Tuberculosis	,
		Past_Tuberculosis	,
		HIV
		, [Discharge_Status],
		[OutcomeDate],
		[Export_Date]
		--date_added_to_table
		)
	select try_convert(int, PatientId) as PatientId,
		[NICD Case ID],
		[Name]	,
		[Surname]		,
		[ID Number]		,
		try_convert(int, Age) as age,
		[Age group]		,
		[Sex]	,
		try_convert(date,[Birth Date]) as Birth_date	,
		[Ethnic Group]		,
		try_convert(date,[diagnosis date])	as diagnosis_date,
		try_convert(date,[Admission Date]) as admission_date	,
		LOS	,
		[Facility],
		[Sector]		,
		[Province]		,
		[District]		,
		[Sub District],
		[Healthcare Worker],
		[Ward upon admission],
		[Intensive Care Unit]		,
		[High Care],
		[General Ward]		,
		[Currently Oxygenated]		,
		[Currently Ventilated]		,
		--[Comorbidity],
		[Hypertension]	,
		[Diabetes]	,
		[Cardiac Disease] as[Admission Cardiac]	,
		--[COPD]	,
		[Asthma]	,
		[Chronic Renal Failure]	,
		[Malignancy]	,
		[Tuberculosis]	,
		[Tuberculosis Past]	,
		[HIV Positive] as HIV,
		[Discharge Status],
        try_convert(date,[Outcome Date]) as outcome_date	,
		[Export Date]
		--,getdate()  as [date_added_to_table]
  FROM [DATCOV].[dbo].[DATCOV_import_23082021]
	
	------------------------------------------------------------------------------
	drop table if exists Sandbox.dbo.temp_Covid_admission
	select
	[PatientId],
	NICD_Case_ID,
	[Name]		,
	Surname		,
	ID_Number		,
	Age		,
	Age_group		,
	Sex		,
	try_convert(date,Birth_Date) as Birth_date	,
	Ethnic_Group		,
	try_convert(date,diagnosis_date)	as diagnosis_date,
	try_convert(date,Admission_Date) as admission_date	,
	LOS	,
	Facility		,
	Sector		,
	Province		,
	District		,
	Sub_District		,
	Healthcare_Worker		,
	Ward_upon_admission  ,
	Intensive_Care_Unit		,
	High_Care		,
	General_Ward		,
	null as Isolation_Ward ,		
	--Oxygenated		,
	Currently_Oxygenated		,
	--Ventilated		,
	Currently_Ventilated		,
	Discharge_Status,
    try_convert(date,OutcomeDate) as outcome_date	,
	--try_convert(date,export_date,101) as export_date ,
	export_date,
	null as  pmi_id,
	null as Unmatched,
	null as unconfirmed,
	Comorbidity ,
	Hypertension	,
	Diabetes	,
	Admission_Cardiac	,
	COPD	,
	Asthma	,
	Chronic_Renal	,
	Malignancy	,
	Current_Tuberculosis	,
	Past_Tuberculosis	,
	HIV
	into [Sandbox].[dbo].[temp_Covid_admission]
	from [Sandbox].[dbo].[Covid_admission]
END
